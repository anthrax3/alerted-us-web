machine:
  services:
    - docker

dependencies:
  cache_directories:
    - "~/docker"
  override:
    - pip install -U tutum requests==1.7.0 docker-compose==1.4.2

test:
  pre:
    - docker-compose up -d
    - docker-compose run db sh -c 'exec psql -h "$DB_PORT_5432_TCP_ADDR" -p "$DB_PORT_5432_TCP_PORT" -U postgres -c "CREATE EXTENSION IF NOT EXISTS POSTGIS"'
    
  override:
    - docker-compose run web ./scripts/run_ci_tests.sh

  post:
    - docker login -e $DOCKER_EMAIL -u $DOCKER_USER -p $DOCKER_PASS
    - docker tag repo_web zephell/alerted-us-web:$CIRCLE_BUILD_NUM-$CIRCLE_SHA1
    - docker push zephell/alerted-us-web:$CIRCLE_BUILD_NUM-$CIRCLE_SHA1
    - cp reports/*.xml $CIRCLE_TEST_REPORTS
